import React from "react";

import {
  TableRow,
  TableCell,
  Collapse,
  Table,
  Box,
  TableBody,
  Typography,
  IconButton,
} from "@mui/material";
import {TableHead} from "@nqminds/ui-components";

import {styled} from "@mui/system";
import CveSeverityTableCell from "./cve-severity-table-cell";
import {sortBy} from "lodash";
import {Check, KeyboardArrowRight} from "@mui/icons-material";

const Row = styled(TableRow)(({theme: {palette}}) => ({
  paddingBottom: 0,
  paddingTop: 0,
  background: palette.background.default,
}));

const cveURL = "https://nvd.nist.gov/vuln/detail/";
// Open CVE in a new tab window
function openCveLink(id: cve["id"]) {
  if (id) {
    const win = window.open(new URL(id, cveURL), "_blank", "incognito=yes");
    if (win != null) {
      win.focus();
    }
  }
}

export default function CveTable({open, cves}: props) {
  let content = (
    <Typography>This component has no known vulnerabilities</Typography>
  );

  if (cves.length) {
    const orderedList = sortBy(cves, ({baseScore}) => -baseScore);
    content = (
      <Table>
        <TableHead
          headers={[
            "Severity",
            "Severity score",
            "Common weakness enumeration",
            "Memory safe",
            "Description",
            "More info at NVD",
          ]}
        />
        <TableBody>
          {orderedList.map(
            ({id, description, cwes, baseScore, baseSeverity}) => {
              const memorySafe = !!cwes.find(({memoryCwe}) => memoryCwe);
              return (
                <TableRow
                  className={memorySafe ? "memory-safe-row" : undefined}
                  key={id}
                >
                  <CveSeverityTableCell severity={baseSeverity} />
                  <TableCell>{baseScore}</TableCell>
                  <TableCell>{cwes.map(({name}) => name).join(", ")}</TableCell>
                  <TableCell>{memorySafe ? <Check /> : null}</TableCell>
                  <TableCell>{description}</TableCell>
                  <TableCell><IconButton onClick={() => openCveLink(id)}><KeyboardArrowRight/></IconButton></TableCell>
                </TableRow>
              );
            },
          )}
        </TableBody>
      </Table>
    );
  }
  return (
    <Row>
      <TableCell style={{paddingBottom: 0, paddingTop: 0}} colSpan={10}>
        <Collapse in={open} timeout="auto" unmountOnExit>
          <Box sx={{margin: 1}}>{content}</Box>
        </Collapse>
      </TableCell>
    </Row>
  );
}

type props = {
  open: boolean;
  cves: cve[];
};

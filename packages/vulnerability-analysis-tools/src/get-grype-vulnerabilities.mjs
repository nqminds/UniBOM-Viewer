import { fileURLToPath } from "url";
import { dirname } from "path";
import path from "node:path";
import fs from "fs";

/**
 * Parses the text vulerability report generated by grype
 *
 *@example
 *getVulnerabilities('../input/reports/vulnerability_report_nodeproject');
 *
 *@param {string} vulReport - Path to grype vulnerability report file or text data
 *@returns {object[]} - Returns an Array of objects
 */
export async function getVulnerabilities(vulReport) {
  const __filename = fileURLToPath(import.meta.url);
  const __dirname = dirname(__filename);

  let data;
  const resolvedPath = path.resolve(process.cwd(), vulReport);

  try {
    // check if the path exists.
    if (fs.existsSync(resolvedPath)) {
      data = fs.readFileSync(resolvedPath, "utf-8");
      // check relative path to __dirname
    } else if (fs.existsSync(path.resolve(__dirname, vulReport))) {
      data = fs.readFileSync(path.resolve(__dirname, vulReport), "utf-8");
    } else {
      data = vulReport;
    }
  } catch (error) {
    throw new Error(`The file path provided is invalid: ${error}`);
  }

  const lines = data.split("\n").slice(1);

  const vulnerabilities = lines
    .map((line) => {
      // TODO: find a beter solution to account for missing fields in the text file
      const parts = line.split(/\s{2,}/);
      if (parts.length === 6) {
        parts.splice(2, 0, ""); // insert an empty string at index 2
      }
      const [name, installed, fixedIn, type, vulnerability, severity] = parts;

      return {
        name,
        installed,
        fixedIn,
        type,
        vulnerability,
        severity,
      };
    })
    .filter((vul) => vul.name); // remove undefined entries

  return vulnerabilities;
}

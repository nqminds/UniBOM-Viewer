/* eslint-disable no-console */
import { fileURLToPath } from "url";
import path from "node:path";
import { dirname } from "path";
import { execFileSync } from "child_process";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Generate a vulnerability report based on the provided directory.
 *
 * @example
 * generateVulnerabilityReport("~/Repositories/cyber", "nodeproject");
 *
 * @param {string} directoryPath - Path to the directory.
 * @param {string} fileName - Name of the output JSON file for the SBOM.
 */
export function generateVulnerabilityReport(directoryPath, fileName) {
  // Execute syft command
  const sbomFile = path.resolve(__dirname, `../input/sboms/${fileName}.json`);
  console.log("Running syft to generate SBOM...");
  const syftArgs = [
    "--scope",
    "all-layers",
    directoryPath,
    "-o",
    "cyclonedx-json",
    "--file",
    sbomFile,
  ];

  execFileSync("syft", syftArgs);

  console.log("SBOM generation completed.");

  // Execute grype command
  const vulnerabilityReportFile = path.resolve(
    __dirname,
    `../input/reports/vulnerability_report_${fileName}`
  );

  console.log("Running grype to generate vulnerability report...");
  const grypeArgs = [`sbom:${sbomFile}`, "--file", vulnerabilityReportFile];

  execFileSync("grype", grypeArgs);
  console.log(`Vulnerability report saved to: ${vulnerabilityReportFile}`);
}

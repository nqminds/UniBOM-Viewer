/* eslint-disable no-console */
import { fileURLToPath } from "url";
import fs from "fs";
import path from "node:path";
import { dirname } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

function cleanCpe(cpe) {
  const parts = cpe.split("\\/");
  if (parts.length > 1) {
    const lastPart = parts[parts.length - 1];
    const subParts = lastPart.split(":");
    const cleaned = `cpe:2.3:a:${subParts[0]}:${subParts.slice(1).join(":")}`;
    return cleaned.split("_")[0];
  }
  return cpe;
}

/**
 * Extracts CPE values from components.
 *
 * @param {string} filePath - Path to the SBOM JSON file.
 * @returns {string[]} - Array of CPE strings.
 */
export async function getCpes(filePath) {
  // Read the CycloneDx SBOM JSON file
  const sbomData = fs.readFileSync(path.resolve(__dirname, filePath));
  const sbomJson = JSON.parse(sbomData);

  const listOfCpes = [];

  // extract CPE values from components
  sbomJson.components.forEach((component) => {
    if (component.cpe) {
      const cleanedCpe = cleanCpe(component.cpe);
      listOfCpes.push(cleanedCpe);
    }
  });
  return listOfCpes;
}

// Sample usage:
// getCpes("../input/cyberxbom.json");

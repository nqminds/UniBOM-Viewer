/* eslint-disable promise/catch-or-return */
/* eslint-disable no-console */
import { fileURLToPath } from "url";
import { promises as fs } from "fs";
import axios from "axios";
import path from "node:path";
import { dirname } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const configContent = await fs.readFile(
  path.join(__dirname, "../config/config.json")
);
const config = JSON.parse(configContent);
const apiKey = config.apiKey;

const baseUrl = "https://services.nvd.nist.gov/rest/json/cpes/2.0?";
const headers = {};

if (apiKey) {
  headers.apiKey = apiKey;
}

/**
 * Extract vendor name from a full CPE string.
 *
 * @param {string} cpe - The full CPE string must in this form: 'vendorName:***'.
 * @returns {string} The vendor name.
 */
function extractVendorFromCPE(cpe) {
  const parts = cpe.split(":");
  return parts[1] || "";
}

/**
 * Fetch all historical versions of a given CPE.
 *
 * @param {string} cpeName - The base CPE name eg: busybox:busybox:1.33.2.
 * @returns {object[]} - An array of historical CPEs.
 */
// eslint-disable-next-line no-unused-vars
export async function fetchHistoricalCPEs(cpeName) {
  const vendorName = extractVendorFromCPE(cpeName);

  const formattedUrl = `${baseUrl}cpeMatchString=cpe:2.3:*:${vendorName}`;

  let historicalCPEs = [];

  try {
    const response = await axios.get(formattedUrl, { headers });

    if (response.data.products && Array.isArray(response.data.products)) {
      historicalCPEs = response.data.products.map((product) => {
        return {
          cpeName: product.cpe.cpeName,
          title:
            product.cpe.titles?.find((title) => title.lang === "en")?.title ||
            "N/A",
          lastModified: product.cpe.lastModified,
          created: product.cpe.created,
          deprecated: product.cpe.deprecated,
        };
      });
    }
  } catch (error) {
    throw new Error(`Error fetching historical CPEs for ${cpeName}:`, error);
  }
  return historicalCPEs;
}

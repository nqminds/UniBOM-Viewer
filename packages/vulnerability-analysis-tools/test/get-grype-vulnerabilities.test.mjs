import { getVulnerabilities } from "../src/get-grype-vulnerabilities.mjs";
import { describe, test, expect } from "@jest/globals";

describe("getVulnerabilities", () => {
  test("should return an array of json objects", async () => {
    const vulData = `
        NAME     INSTALLED  FIXED-IN  TYPE   VULNERABILITY  SEVERITY 
        openssl  3                    conan  CVE-2023-0401  High      
        openssl  3                    conan  CVE-2023-0217  High      
        openssl  3                    conan  CVE-2023-0216  High      
        openssl  3                    conan  CVE-2022-3996  High      
        openssl  3                    conan  CVE-2022-3786  High      
        openssl  3                    conan  CVE-2022-3602  High      
        openssl  3                    conan  CVE-2022-3358  High      
        openssl  3                    conan  CVE-2022-1473  High      
        openssl  3                    conan  CVE-2021-4044  High      
        openssl  3                    conan  CVE-2023-3446  Medium    
        openssl  3                    conan  CVE-2023-2975  Medium    
        openssl  3                    conan  CVE-2023-1255  Medium    
        openssl  3                    conan  CVE-2022-4203  Medium    
        openssl  3                    conan  CVE-2022-1434  Medium    
        openssl  3                    conan  CVE-2022-1343  Medium    
        
        `;

    const vulDataMissingField2 = `
        openssl 3         conan  CVE-2023-0401  High   
        `;

    const result = await getVulnerabilities(vulData);
    const result2 = await getVulnerabilities(vulDataMissingField2);

    const isValid = result.every((item) => {
      return (
        typeof item.name === "string" &&
        typeof item.installed === "string" &&
        typeof item.fixedIn === "string" &&
        typeof item.type === "string" &&
        typeof item.vulnerability === "string" &&
        typeof item.severity === "string"
      );
    });

    const isValid2 = result2.every((item) => {
      return (
        item.name === "openssl" &&
        item.installed === "" &&
        item.fixedIn === "3" &&
        item.type === "conan" &&
        item.vulnerability === "CVE-2023-0401" &&
        item.severity === "High"
      );
    });

    // expect the correct data types
    expect(isValid).toBeTruthy();
    expect(isValid2).toBe(true);
  });
});

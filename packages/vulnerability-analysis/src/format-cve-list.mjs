import pluck from "lodash.pluck";
import flatten from "lodash.flatten";
import uniq from "lodash.uniq";
/**
 * @param {object[]} cves - Array of CVEs
 */

/**
 * Flattens and formats SBOM/CVE from NVD API.
 *
 * @param {object[]} sbomComponents - Array of SBOM component objects from NVD API.
 * @param {object[][]} componentCves - Nested array of CVE objects from NVD API.
 * @returns {object[]} Array of SBOM components with formatted and unique list of CVE objects.
 */
export default function formatSbomComponentList(sbomComponents, componentCves) {
  return sbomComponents.map(({name, version, licenses}, index) => ({
    name,
    version,
    licenses: pluck(licenses, "license.name").join(", "),
    cves: formatCveList(componentCves[index]),
  }));
}

function formatCveList(cveList) {
  return cveList.map(({cve: {id, descriptions, metrics, weaknesses}}) => ({
    id,
    description: getLocaleItem(descriptions)[0],
    ...getNistScores(metrics),
    cwes: getCwes(weaknesses),
  }));
}

function getLocaleItem(list) {
  return list.reduce((iter, {lang, value}) => {
    if (lang === "en") {
      iter.push(value);
    }
    return iter;
  }, []);
}

function getNistScores(cveMetrics) {
  const metric = cveMetrics.cvssMetricV31 ?? cveMetrics.cvssMetricV2;
  const nistMetric =
    metric.find(({source}) => source.includes("nist")) || metric[0];

  return nistMetric.cvssData;
}

function getCwes(cveWeaknesses) {
  return uniq(getLocaleItem(flatten(pluck(cveWeaknesses, "description"))));
}

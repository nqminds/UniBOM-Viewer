import sbom from "../input/sbom.json" assert {type: "json"};
import cweDictionary from "../input/cwe-map.json" assert {type: "json"};
import config from "config";

import getCves from "./get-cves.mjs";
import formatSbomComponentList from "./format-cve-list.mjs";

const apiKey = config.get("apiKey");

const {components} = sbom;

export default async function getVulnerabilityAnalysis() {
  const cvePromiseList = await Promise.all(
    components.map(({cpe}) => getCves(cpe, apiKey)),
  );
  const sbomComponents = formatSbomComponentList(components, cvePromiseList);

  const ouput = sbomComponents.map((component) => ({
    ...component,
    cves: component.cves.map((cve) => ({
      ...cve,
      cwes: cve.cwes.map(
        (id) => cweDictionary[id.split("-")[1]] ?? {name: id, memory: false},
      ),
    })),
  }));

  return ouput;
}

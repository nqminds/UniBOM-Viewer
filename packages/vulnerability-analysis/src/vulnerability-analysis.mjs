/* eslint-disable no-await-in-loop */
import sbom from "../input/sbom.json" assert {type: "json"};
import cweDictionary from "../input/cwe-map.json" assert {type: "json"};

import getCves from "./get-cves.mjs";
import formatSbomComponentList from "./format-cve-list.mjs";
import convertedComponents from "./purl-to-cpe.mjs";

const {components} = sbom;

export default async function getVulnerabilityAnalysis(apiKey) {
  const cpeComponents = await convertedComponents(components);

  const cveLookup = await Promise.all(
    cpeComponents.map(async (component) => ({
      ...component,
      cves: await getCves(component.cpe, apiKey),
    })),
  );
  const sbomComponents = cveLookup.map(formatSbomComponentList);

  const ouput = sbomComponents.map((component) => ({
    ...component,
    cves: component.cves.map((cve) => ({
      ...cve,
      cwes: cve.cwes.map(
        (id) => cweDictionary[id.split("-")[1]] ?? {name: id, memoryCwe: false},
      ),
    })),
  }));

  return ouput;
}

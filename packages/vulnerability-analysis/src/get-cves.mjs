import fetch, {Request} from "node-fetch";

const baseUrl = new URL("https://services.nvd.nist.gov/rest/json/cves/2.0");

/**
 * Retrieves a list of all CVEs which are weaknesses for the given CPE
 *
 * @param {string} cpe - CPE string which is given from SBOM
 * @param {string} [apiKey] - API key which increases API rate limit
 * @returns {Array} - List of CVEs
 */
export default async function getCves(cpe, apiKey) {
  const response = await fetch(
    new Request(
      new URL(
        `${baseUrl}?${new URLSearchParams({
          cpeName: cpe.replace("cpe:/", "cpe:2.3:"),
        })}`,
      ),
      {
        headers: {
          apiKey,
        },
      },
    ),
  );

  if (response.status === 200) {
    return (await response.json()).vulnerabilities;
  } else {
    // TODO: Soft fail
    return [];
  }
}

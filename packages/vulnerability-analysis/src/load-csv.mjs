import {fileURLToPath} from "url";
import path from "path";
import {dirname} from "path";
import {readFile, writeFile} from "fs/promises";
import neatCsv from "neat-csv";

// TODO: move to scripts file
// Get the file path of the current module
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const keyWords = [
  "memory safety",
  "Buffer Overflow",
  // "Use-After-Free",
  "Null Pointer Dereference",
  "Memory Leakage",
  "Integer Overflow/Underflow",
  "Integer Overflow",
  "Integer Underflow",
  "Format String Vulnerabilities",
];

const keyWordMatchCase = keyWords.join("|");

// Read the CSV file

const data = await readFile(path.resolve(__dirname, "../input/cwe.csv"));
const allCwes = await neatCsv(data);
const cweDictionary = allCwes.reduce((cweMap, row) => {
  const memoryCwe = !!Object.values(row)
    .join(", ")
    .match(new RegExp(`\\b(${keyWordMatchCase})\\b`, "gi"));

  cweMap[row["CWE-ID"]] = {
    name: row.Name,
    memoryCwe,
  };

  return cweMap;
}, {});

await writeFile(
  path.resolve(__dirname, "../input/cwe-map.json"),
  JSON.stringify(cweDictionary),
);
